#!/bin/bash
#
. i_config

##***********************************************************************************************##
## HOLA!
##***********************************************************************************************##

if [ "$1" = "hola" ]
then

	echo " objetivo: Manejo del  arbol de codigo APEX."

##***********************************************************************************************##
## Exportacion de todo el codigo
##***********************************************************************************************##
#@ arbol exp                            -- Compacta el arbol de codigo en $toba_dir/..

elif [ "$1" = "exp" ]
then

	cd $toba_dir/..
	if [ -e toba_${e_dia}.tar.gz ]
	then
		sp_ "Ya existe una exportacion, desea eliminarla?"
		while [ : ]
		do
			read respuesta
			if [ $respuesta = "S" ]
			then
				rm -f toba_${e_dia}.tar.gz
				# Esta anda mal en el cygwin
				# tar -cvf - toba | gzip > toba_${e_dia}.tar.gz
				tar -cvf $e_serial toba
				echo "Comprimiendo archivos..."
				gzip $e_serial
				mv ${e_serial}.gz toba_${e_dia}.tar.gz
			fi
			break
		done
	else
		tar -cvf $e_serial toba
		echo "Comprimiendo archivos..."
		gzip $e_serial
		mv ${e_serial}.gz toba_${e_dia}.tar.gz
	fi

##***********************************************************************************************##
## Crea una
##***********************************************************************************************##
#@ arbol release                        -- Crea un juego de codigo publicable a 3ros

elif [ "$1" = "release" ]
then

#----------- Creo una carpeta de trabajo

	echo
	echo "1) Creando los archivos"
	cd $toba_dir/..
	carpeta=toba_${e_serial}
	cp -R $toba_dir $carpeta
	cd $carpeta

#----------- Elimino las carpetas CVS

	echo "2) Eliminando carpetas CVS"
	arbol del_cvs > delete_cvs
	sh < delete_cvs
	rm -f delete_cvs

#----------- Elimino las cosas que no se publican

	echo "3) Eliminando informacion interna"
	rm -Rf var
	rm -Rf sql/var
	rm -Rf php/var
	rm -f sql/datos_instancia.sql
	rm -f proyectos/*/sql/datos_instancia.sql
	rm -f php/.cvsignore
	rm -f php/instancias*.php
	rm -Rf bin/des
	
#----------- Elimino todos los proyectos menos 'vacio' y 'eventos'

	cd proyectos
	echo "4) Eliminando proyectos"
	for a in `ls -l | egrep "^d|^l" | awk '{ print $9 }'`
	do
		echo " --> Eliminar PROYECTO: $a"
		rm -Rf $a
	done

	echo
	echo "** OK ** $carpeta"

##***********************************************************************************************##
## Eliminacion de carpetas CVS
##***********************************************************************************************##
#@ arbol del_cvs                        -- Genera sentencias de eliminacion de carpetas CVS

elif [ "$1" = "del_cvs" ]
then

	# FALTA: .cvsignore
	ls  -lRa | egrep "^\..*svn" | sed "s/://;s/^/rm -Rf /"


##***********************************************************************************************##
## Compilacion
##***********************************************************************************************##
#@ arbol comp                           -- Compila informacion de la base a PHP

elif [ "$1" = "comp" ]
then

	item $instancia /consola/exp_def_obj

##***********************************************************************************************##
## Eliminacion de carpetas CVS
##***********************************************************************************************##
#@ arbol del_comp                        -- Elimina las definiciones PHP

elif [ "$1" = "del_comp" ]
then

	cd $toba_dir/php/nucleo
	rm -f definiciones/objetos/*.php

##***********************************************************************************************##
## Ver Cosas Pendientes
##***********************************************************************************************##
elif [ "$1" = "pendiente" ]
then
	pendiente $0

##***********************************************************************************************##
## Ayuda
##***********************************************************************************************##
else
	ayuda $0
fi
