#!/bin/bash
#
. i_config

#----------> La clave de este script es iterar por directorios y actuar ???

# Funcionalidad no implementada
#==> * Control de practivas no permitidas
#==> * Reemplazador de palabras
#==> * Mensajes entre desarrolladores
#==> * CVS!!

	lista_dir_php=$d_salida/php_directorios.txt
	lista_arc_php=$d_salida/php_archivos.txt
	lista_arc_php_lineas=$d_salida/php_archivos_lineas.txt

##***********************************************************************************************##
## HOLA!
##***********************************************************************************************##

if [ "$1" = "hola" ]
then

	echo " objetivo: Realizar operaciones sobre archivos PHP."

##***********************************************************************************************##
## Manejo de la documentacion automatica de codigo
##***********************************************************************************************##
#@ cod ad SCRIPT-PHP modo                      -- Extrae la documentacion de SCRIPT-PHP

elif [ "$1" = "ad" ]
then

	if [ -z $3 ]
	then
		prog=$d_awk/autodoc_php-txt_00.awk
	else
		case $3 in
			"norm") 				prog=$d_awk/autodoc_php-txt_00.awk;;
			"con")		 		prog=$d_awk/autodoc_php-bsh_00.awk;;
			"linea") 			prog=$d_awk/autodoc_php-txt_01.awk;;
			"comp") 				prog=$d_awk/autodoc_php-txt_02.awk;;
			"xml") 				prog=$d_awk/autodoc_php-xml_00.awk;;
			*) 					prog=$d_awk/autodoc_php-txt_01.awk;;
		esac
	fi
	awk -f $prog $2

## testeo
elif [ "$1" = "test" ]
then
 	cod ad $d_raiz/php/lib/canal.php xml > $d_doc/php/lib/canal.xml

##***********************************************************************************************##
## Identifica los archivos y directorios PHP que conforman APEX
##***********************************************************************************************##
#@ cod archivos                                -- Determina directorios y archivos PHP en APEX
elif [ "$1" = "archivos" ]
then

	# Armo la lista de directorios
	echo
	echo " Lista de DIRECTORIOS en '$lista_dir_php'"
	echo
	ls -lR $d_php | egrep $d_php | egrep -v "3ros|var|CVS" | sed s/://g > $lista_dir_php
	cat $lista_dir_php

	# Armo la lista de archivos
	echo
	echo " Lista de ARCHIVOS en '$lista_arc_php'"
	echo
	rm -f $lista_arc_php
	for a in `cat $lista_dir_php`
	do
		ls ${a}/*php >> $lista_arc_php
	done
	cat $lista_arc_php

##***********************************************************************************************##
## Contar cantidad de lineas de los PHP del directorio
##***********************************************************************************************##
#@ cod lineas                                  -- Lineas de codigo partiendo de $APEX_DIR/php
elif [ "$1" = "lineas" ]
then

	echo -n "CONTAR LINEAS: "
	rm -f $lista_arc_php_lineas
	for a in `cat $lista_arc_php`
	do
		wc -l $a >> $lista_arc_php_lineas
		echo -n "*"
	done
	
	echo
	echo "LINEAS por ARCHIVO"
	echo
	awk '{s += $'$1'; print $1 "\t" $2} END {print "\nTOTAL: " s " lineas"}' $lista_arc_php_lineas
	
##***********************************************************************************************##
## Busca cadenas en el codigo PHP
##***********************************************************************************************##
#@ cod buscar CADENA                           -- Busca ocurrencias de CADENA en el arbol de codigo
elif [ "$1" = "buscar" ]
then

	if [ -n "$2" ]
	then
		for a in `cat $lista_arc_php`
		do
			egrep -inH "$2" $a
		done
	else
		echo "no se especifico el patron a buscar"
	fi


###***********************************************************************************************##
### Identifica los archivos y directorios PHP que conforman APEX
###***********************************************************************************************##
#@ cod acceso                                  -- Muestra los puntos de accesp
#@  - [full]           - Muestra parametros activos
#@  - [db]             - Muestra el parametro de conexion a la base APL
#@  - [cdb "X" "Y"]    - Comenta el patron "X$", descomenta el patron "$Y"
elif [ "$1" = "acceso" ]
then

	if [ -z "$2" ]
	then
		cat $archivo_config
	else
		case "$2" in
			"db") #---> Muesta la coneccion a la base APL
					for a in `cod acceso`
					do
						echo
						echo "-- PUNTO de ACCESO -- $a"
						echo 
						egrep "apex_pa_db" $a
					done
					;;
			"full") #---> Muestra todos los parametros de inicializacion
					for a in `cod acceso`
					do
						echo
						echo "-- PUNTO de ACCESO -- $a"
						echo 
						egrep "define" $a | egrep -v "^//"
					done
					;;
			"cdb") #--- Cambiar base APL
					if [ -z "$3" ] || [ -z "$4" ]
					then
						echo "SINTAXIS: cod acceso cdb 'PATRON'(^ a comentar)' 'PATRON'(^ a descomentar)"
					else
						for a in `cod acceso`
						do
							mv $a ${a}_${e_serial}
							sed '/apex_pa_db.*'$3'$/s/^/\/\//' ${a}_${e_serial} | 
							sed '/apex_pa_db.*'$4'$/s/^\/\///' > $a
							# egrep "apex_pa_db" 
						done
					fi
					;;

			*) 	echo "Incorrecto.";;
		esac
	fi

##***********************************************************************************************##
## Ejecutar un archivo de SED del directorio
##***********************************************************************************************##
## cod interface                               -- Extrae la interface de los archivos PHP esenciales
elif [ "$1" = "interface" ]
then
	
	as=$d_salida/interface_interna.txt

	echo "----------------- SOLICITUD ----------------" > $as
	cod ad $d_php/nucleo/solicitud.php >> $as
	echo >> $as
	echo "----------------- ANCESTRO OBJETOS ----------------" >> $as
	cod ad $d_php/nucleo/objeto.php >> $as

	echo >> $as
	echo "----------------- VINCULADOR ----------------" >> $as
	cod ad $d_php/nucleo/browser/vinculador.php >> $as
	echo >> $as
	echo "----------------- HILO ----------------" >> $as
	cod ad $d_php/nucleo/browser/hilo.php >> $as
	echo >> $as
	echo "----------------- RECURSOS ----------------" >> $as
	cod ad $d_php/nucleo/browser/recurso.php >> $as

	echo >> $as
	echo "----------------- OBJETO ABMS ----------------" >> $as
	cod ad $d_php/nucleo/browser/clases/abms.php >> $as
	echo >> $as
	echo "----------------- OBJETO HOJA ----------------" >> $as
	cod ad $d_php/nucleo/browser/clases/hoja.php >> $as
	echo >> $as
	echo "----------------- OBJETO LISTA ----------------" >> $as
	cod ad $d_php/nucleo/browser/clases/lista.php >> $as
	echo >> $as
	echo "----------------- OBJETO FILTRO ----------------" >> $as
	cod ad $d_php/nucleo/browser/clases/filtro.php >> $as

	echo >> $as
	echo "----------------- PAGINA ----------------" >> $as
	cod ad $d_php/nucleo/browser/interface/pagina.php >> $as
	echo >> $as
	echo "----------------- Elementos de INTERFACE ----------------" >> $as
	cod ad $d_php/nucleo/browser/interface/ei.php >> $as
	echo >> $as
	echo "----------------- Elementos de Formulario ----------------" >> $as
	cod ad $d_php/nucleo/browser/interface/ef.php >> $as
	echo >> $as
	echo "----------------- HTML - FORM ----------------" >> $as
	cod ad $d_php/nucleo/browser/interface/form.php >> $as
	echo >> $as
	echo "----------------- Formateo ----------------" >> $as
	cod ad $d_php/nucleo/browser/interface/formateo.php >> $as

	cat $as
	

##***********************************************************************************************##
## Ejecutar un archivo de SED del directorio
##***********************************************************************************************##
## cod sed                                    -- Ejecuta un guion de SED en el directorio
elif [ "$1" = "sed" ]
then

# no esta terminado!!!!

	if [ -e cod.sed ]
	then

		dir_old=cod.sed.$e_serial
		mkdir $dir_old

		if [ -z $2 ]
		then
			mv * $dir_old
		else
			mv $2 $dir_old
		fi

		for i in `ls $dir_old`
		do
			sed -f cod.sed $dir_old/$i > $i
		done
	else
		echo "No se encuentra el archivo \"cod.sed\" en el directorio. "
	fi

##***********************************************************************************************##
## Documentacion de TRAC
##***********************************************************************************************##
#@ cod trac                                   -- Crea la documentacion de interfaces para TRAC
elif [ "$1" = "trac" ]
then
		#Ejecuto el PHP
		php $d_bin/php/doc_trac.php "$toba_dir"
		resultado=$?
		#echo $resultado
		if [ $resultado = "100" ]
		then
			echo "OK!!!"
		elif [ $resultado != "200" ]
		then 
			echo " ATENCION: Error ejecutando el PHP"
		fi

##***********************************************************************************************##
## Ver Cosas Pendientes
##***********************************************************************************************##
elif [ "$1" = "pendiente" ]
then
	pendiente $0

##***********************************************************************************************##
## Ayuda
##***********************************************************************************************##
else
	ayuda $0
fi
