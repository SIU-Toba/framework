#!/bin/bash
#
. i_config

# Funcionalidad no implementada
#==> * Creacion de bases que soportan PostGIS

##***********************************************************************************************##
## HOLA!
##***********************************************************************************************##

if [ "$1" = "hola" ]
then

	echo " objetivo: Realizar operaciones sobre el motor PostgreSQL de <I> (Instancia)."
	echo "           Tiene que existir al menos una instancia declarada en \"\$toba_dir/php/instancia.php\""
	echo "           Si no se especifica una <I> se utiliza la variable de entorno \"\$toba_instancia\""
	echo "           AHORA: <I> = $toba_instancia"

##***********************************************************************************************##
## Borrar archivo PID si el motor se cae mal
##***********************************************************************************************##
## db borrar_pid                               -- Borra el archivo .pid

elif [ "$1" = "borrar_pid" ]
then
	
	echo
	sp_ "Esto puede causar PROBLEMAS, esta seguro"
	while [ : ]
	do
		read respuesta
		if [ $respuesta = "S" ]
		then
			rm -f /usr/local/pgsql/data/postmaster.pid  				# harcode!
			controlar "Borrar PID"
		fi
		break
	done

##***********************************************************************************************##
## Listar bases existentes
##***********************************************************************************************##
#@ db [<I>] listar                             -- Lista las bases existentes en el motor de <I>

elif [ "$1" = "listar" ]
then
	
	psql -P border=2 $db_string -l

##***********************************************************************************************##
## Estadisticas generales
##***********************************************************************************************##
#@ db [<I>] stat                               -- Estadisticas generales del motor de <I>

elif [ "$1" = "stat" ]
then
	echo "Procesos 'postgres' (uno por cliente conectado)"
	pgsql_consultar "SELECT * FROM pg_stat_activity" 

##***********************************************************************************************##
## Estadisticas del motor por base (conexiones, etc)
##***********************************************************************************************##
#@ db [<I>] stat_db                            -- Estadisticas por BASE en el motor de <I>

elif [ "$1" = "stat_db" ]
then
	echo "Clientes conectados por DB"
	pgsql_consultar "SELECT * FROM pg_stat_database"

##***********************************************************************************************##
## Crear BASE
##***********************************************************************************************##
#@ db [<I>] crear BASE                         -- Crea BASE

elif [ "$1" = "crear" ]
then
	createdb -U $db_usuario -h $db_host -p $db_puerto $2 
	controlar "Crear base '$2'"
	if [ "$3" = "postgis" ]
	then
		echo "**--  POSTGIS  --**"
		cd $toba_dir/sql/extra
		psql -v ON_ERROR_STOP= -U $db_usuario -h $db_host -p $db_puerto -d $2 < postgis.sql
		psql -v ON_ERROR_STOP= -U $db_usuario -h $db_host -p $db_puerto -d $2 < spatial_ref_sys.sql
	fi

##***********************************************************************************************##
## Borrar BASE
##***********************************************************************************************##
#@ db [<I>] borrar BASE                        -- Borra BASE

elif [ "$1" = "borrar" ]
then
	echo
	sp_ "Desea ELIMINAR la BASE '$2'"
	while [ : ]
	do
		read respuesta
		if [ $respuesta = "S" ]
		then
			dropdb -U $db_usuario -h $db_host -p $db_puerto $2 
			controlar "Borrar base '$2'"
		fi
		break
	done

##***********************************************************************************************##
## Hace un dump de la base
##***********************************************************************************************##
#@ db [<I>] dump [base]                        -- Realiza un DUMP de BASE

elif [ "$1" = "dump" ]
then

	if [ -z $2 ]
	then
		pg_dump $version -d -O -U $db_usuario -h $db_host -p $db_puerto $db_base
	else
		pg_dump $version -d -O -U $db_usuario -h $db_host -p $db_puerto $2
	fi

##***********************************************************************************************##
## Vacuum full analize sobre base
##***********************************************************************************************##
#@ db [<I>] vac [base]                         -- Realiza un VACUUM FULL ANALYZE en <I> o [base]

elif [ "$1" = "vac" ]
then
	if [ -z $2 ]
	then
		vacuumdb --full --analyze $db_string
	else
		vacuumdb --full --analyze --dbname $2 -U $db_usuario -h $db_host -p $db_puerto
	fi

##***********************************************************************************************##
## Ejecuta un script sobre BASE
##***********************************************************************************************##
#@ db [<I>] run SCRIPT [base]                  -- Ejecuta SCRIPT en <I> o [base]

elif [ "$1" = "run" ]
then
 
	if [ -z $4 ]
	then
		parar=""
	else
		parar=" -v ON_ERROR_STOP= "
	fi

	if [ -z $3 ]
	then
		psql -f $2 $parar $db_string
	else
		psql $parar -f $2 -U $db_usuario -h $db_host -p $db_puerto -d $3
	fi

##***********************************************************************************************##
## Ejecutar un SQL contra la base
##***********************************************************************************************##
#@ db [<I>] sql "comando sql"                  -- Ejecuta SQL DIRECTO contra <I>

elif [ "$1" = "sql" ]
then

	pgsql_consultar "$2"
	
##***********************************************************************************************##
## Ver Cosas Pendientes
##***********************************************************************************************##
elif [ "$1" = "pendiente" ]
then
	pendiente $0

##***********************************************************************************************##
## Ayuda
##***********************************************************************************************##
else
	ayuda $0
fi
