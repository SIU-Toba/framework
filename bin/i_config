#!/bin/bash
#
. i_func 		# Incluyo la funcionalidad standart

##***********************************************************************************************##
## 1) Inicializo variables generales
##***********************************************************************************************##

#-------------------------------------------------------------------------
#------- Directorios  ----------------------------------------------------
#-------------------------------------------------------------------------

# Controlo que exista el directorio TOBA_DIR
if [ -d $toba_dir ]
then
	d_bin=$toba_dir/bin					# carpeta donde estan los SCRIPTs BASH y PHP de linea de comandos
	d_salida=$d_bin/salida				# carpeta donde se guarda la salida de los scripts
	d_entrada=$d_bin/entrada				# carpeta donde se guarda la entrada de los scripts
	d_awk=$d_entrada/awk					# carpeta donde se guardan los scrips AWK
	d_sql=$toba_dir/sql					# carpeta donde estan los SCRIPTs SQL
	d_var=$toba_dir/var					# carpeta donde se graba informacion circustancial
	d_proy=$toba_dir/proyectos			# carpeta donde se guardan los proyectos
	d_doc=$toba_dir/doc					# carpeta donde se guardan la documentacion
	d_php=$toba_dir/php					# carpeta donde se guardan los scrips PHP
else
	echo
	echo " ATENCION, la variable de entorno \"toba_dir\" no esta definida"	
	echo
	exit
fi

#-------------------------------------------------------------------------
#------- PostgreSQL ------------------------------------------------------
#-------------------------------------------------------------------------

#--[ 1 ]-- Selecciono la instancia

	#Busco las instancias disponibles
	#php $d_bin/php/instancias.php "$toba_dir" "$toba_instancia" "$1"
	instancia=`php $d_bin/php/instancias.php "$toba_dir" "$toba_instancia" "$1"`
	resultado=$?
	#echo $resultado
	if [ $resultado = "100" ]
	then
		#El usuario escribio una instancia a mano
		echo
		echo "--- Utilizando instancia: $instancia"
		echo
		shift # Saco el parametro de la llamada
	elif [ $resultado != "200" ]
	then 
		#200 es el codigo de la instancia por defecto
		echo " ATENCION: No se pudo determinar la instancia "
	fi
	#echo $instancia
	#exit

#--[ 2 ]-- Busco los parametros de esa instancia

	#Esto hay que reemplazarlo por un script de PHP

	archivo_instancias=$d_php/instancias.php # Saco los datos del archivo de configuracion de PHP
	db_motor=`awk -F\" '/'$instancia'.*motor/ { print $4 }' $archivo_instancias`
	db_host=`awk -F\" '/'$instancia'.*profile/ { print $4 }' $archivo_instancias`
	db_usuario=`awk -F\" '/'$instancia'.*usuario/ { print $4 }' $archivo_instancias`
	db_clave=`awk -F\" '/'$instancia'.*clave/ { print $4 }' $archivo_instancias`
	db_base=`awk -F\" '/'$instancia'.*base/ { print $4 }' $archivo_instancias`

	db_puerto=5432
	db_string=" -U $db_usuario -h $db_host -p $db_puerto -d $db_base"
#	db_string=" -U $db_usuario -d $db_base"
	
#-------------------------------------------------------------------------
#------ General  ---------------------------------------------------------
#-------------------------------------------------------------------------

#-- Variables genericas
e_dia=`date +%Y-%m-%d`										# DIA
e_hora=`date +%H_%M_%S`										# HORA
e_serial=`date +%s`											# STRING unico (para cosas temporales)
e_prompt="toba>"												# PROMPT

#-- nomenclatura de archivos SQL
s_sql_ini="pgsql_"											# Prefijo del los archivos SQL
s_sql_fin="*.sql"												# Sufijo de los archivos SQL
s_sql_datos=${s_sql_ini}datos_${instancia}.sql		# Achivo de datos ACTUAL
c_auto="_auto"													# Carpeta donde se guarda la informacion automatica

##***********************************************************************************************##
## 2) Guardo el acceso SCRIPT
##***********************************************************************************************##

echo "$e_dia $e_hora -- $0 -- $*"	>> $d_salida/historico_comandos.txt

##***********************************************************************************************##
##***********************************************************************************************##
