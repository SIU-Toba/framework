#!/bin/bash
#
. i_config

# Funcionalidad no implementada
#==> * el plan de ACTUALIZACION esta harcodeado
#==> * LAS TALBAS NECESITAN UN ESPACIO ATRAS DEL 'create table' PARA QUE ESTO LAS PARSEE BIEN

##***********************************************************************************************##
## HOLA!
##***********************************************************************************************##

if [ "$1" = "hola" ]
then

	echo " objetivo: Mantenimiento de codigo SQL"

##***********************************************************************************************##
## Actualiza los scripts SQL que pueden deducirse del de creacion
##***********************************************************************************************##
#@ sql juntar NIVEL                            -- Unifica los "pgsql_[a|z][0-9]_*.sql" de carpeta

elif [ "$1" = "juntar" ]
then

	# Junta archivos de un nivel, estara siempre ordenado alfanumericamente?
	cat ${s_sql_ini}$2*${s_sql_fin}		> __sql_$2.sql 

##***********************************************************************************************##
## Extrae metadatos
##***********************************************************************************************##
#@ sql metadatos                               -- Extrae METADATOS de los SQL de creacion

elif [ "$1" = "metadatos" ]
then
	item $instancia /consola/info_sql pgsql_a* > ${c_auto}/metadatos.sql
	controlar "Parseo archivos \"pgsql_a*\" del DIRECTORIO"
	# Falta controlar la existencia del borrador!!!
	db run ${c_auto}/__del_mod_datos.sql
	controlar "Elimino metadatos anteriores"
	echo "Insertando registros..."
	db run ${c_auto}/metadatos.sql > $e_serial 2> ${c_auto}/error_imporacion_metadatos.txt
	controlar "Creo metadatos nuevos"
	rm -f $e_serial
	echo "Errores importacion: "
	cat ${c_auto}/error_imporacion_metadatos.txt
	echo "- FIN -"

		
##############################################  TRADUCTORES #######################################

##***********************************************************************************************##
## Migra los SCRIPTS SQL a otros motores.
##***********************************************************************************************##
#@ sql migrar MOTOR                            -- Migra SQL a otro MOTOR (hasta ahora solo informix)
elif [ "$1" = "migrar" ]
then

	if [ -z "$2" ]
	then
		echo "Expecifique el MOTOR - Destino. (informix)"
	else
		case "$2" in
			"informix") #---> Migro el SQL de generacion a ------------- > INFORMIX
							# Esto trabaja desde el directorio actual.
							
				#------ 1) Migro los scripts de creacion
					for a in `ls -1 ${s_sql_ini}a${s_sql_fin}  | awk '{ print $1 }'`
					do
						echo "procesando: $a"
						sed -f $d_entrada/multidb/informix_creacion.sed $a > _auto/migraciones/informix/ifx_$a
					done
				#------ 2) Migro los datos
				#	for a in `ls -1 ${s_sql_datos}${s_sql_fin}  | awk '{ print $1 }'`
				#	do
				#		echo "HOLA: " $a
				#		sed -f $d_entrada/multidb/informix_datos.sed $a > informix/$a
				#		sql tab_drop $a > informix/${a}_drop.sql
				#	done
					echo "Juntando todos los scripts..."
					cd _auto/migraciones/informix
					cat *.sql > completo.sql
					echo "Migracion completada"
					;;
			*) 	echo "Motor destino incorrecto.";;
		esac
	fi

##***********************************************************************************************##
## Actualiza los scripts SQL que pueden deducirse del de creacion
##***********************************************************************************************##
#@ sql juntar NIVEL                            -- Genere el INSERT de la tabla de REVISION

elif [ "$1" = "svn" ]
then
	php $d_bin/php/insert_svn.php $toba_dir apex_revision

##***********************************************************************************************##
## Ver Cosas Pendientes
##***********************************************************************************************##
elif [ "$1" = "pendiente" ]
then
	pendiente $0

##***********************************************************************************************##
## Ayuda
##***********************************************************************************************##
else
	ayuda $0
fi
