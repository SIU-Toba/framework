<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>
 <title>Referencia/Auditoria - SIU-Toba - Trac</title><link rel="start" href="../../wiki.html" /><link rel="search" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/search" /><link rel="help" href="../TracGuide.html" /><link rel="stylesheet" href="../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../chrome/common/css/wiki.css" type="text/css" /><link rel="icon" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/favicon.ico" type="image/x-icon" /><link rel="shortcut icon" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/favicon.ico" type="image/x-icon" /><link rel="alternate" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/wiki/Referencia/Auditoria?format=txt" title="Plain Text" type="text/x-trac-wiki" /><style type="text/css">
.wikipage h2 {border-bottom: 1px solid gray;}

/* trac php syntax highlighting */
.code-block {
    line-height: 1em;
    font-family: Courier, monotype;
    font-size: 12px;
    }
.h_question { color: #0000BB; } /* highlight.default */
.hphp_commentline { color: #FF8000; } /* highlight.comment */
.hphp_operator { color: #007700; } /* highlight.keyword */
.hphp_word { color: #007700; } /* highlight.keyword */
.hphp_default {}
.hphp_variable { color: #0000BB; } /* highlight.default */
.hphp_hstring { color: #DD0000; } /* highlight.string */
.hphp_simplestring { color: #DD0000; } /* highlight.string */
.h_tagunknown {}
.h_default {}

.code-keyword { color: #007700; font-weight: normal; }
.code-lang { color: #0000BB; font-weight: normal; }
.code-comment { color: #FF8000; font-weight: normal;}
.code-string { color: #DD0000; font-weight: normal;}

pre { padding:0; margin: 0}

.tablas-screenshots td:first-child { background-color: #D5CECD; width: 30%}
.tablas-screenshots table { width: 90%; border: 1px solid gray; }
.tablas-screenshots td { }
.tablas-screenshots table.wiki td { border: 1px solid gray; }

#tkt-changes-hdr {
    clear: both;
    padding-top: 30px;
}
.wiki-toc {
    clear: right;
    min-width: 160px;
    background-color:#F7F7F7;    
    border: 1px solid #D7D7D7;
}
.wiki-toc .active {
    background-color: #890C71;
    padding: 1px;
}
.wiki-toc .active a {
    color:white; 
}
.wiki-toc .active a:hover {
    background-color:  #890C71;
}
.indice-general {
/*    background-color: #FFFFDD;*/
}
.wikipage h1 {
    padding-top: 5px;
}
.wikipage h2 {
 padding: 2px;
}
.wikipage h1 {
    font-size: 28px;
}
.wikipage h2 {
    background-color: #890C71;
    color: white;
    padding-left: 10px;
    margin-top: 30px;
    font-size: 100%;
    border: 1px solid gray;
}
.wikipage h3 {
    font-size:100%;
}
li {
    margin-bottom:4px;
}
li * {
    margin-bottom:0;
}
/*a {
 color: #890C71;
}*/
@media print {
 .wiki-toc { display: none }
}
#tkt-changes-hdr, .tkt-chg-list { 
    font-size:80%;
    text-align:right;
}

</style>
 <script type="text/javascript" src="../../chrome/common/js/trac.js"></script>
</head>

			<body>
			<table border='0' cellspacing='0' cellpadding='0' height='48' width='100%'>
			  <tr>
			
				<td class='header-top-left'><img src='../../../../../api/media/logo.png' border='0'/></td>
			    <td class='header-top-right'>
			    		<img border='0' style='vertical-align: middle' src='../../../../../api/media/wiki.png' />
			    	<a href='../../../../../api/index.html'  title='Navegar hacia la documentación PHP'>
			    		<img border='0' style='vertical-align: middle' src='../../../../../api/media/php-small.png' /></a> 
			    	<a href='../../../../../api_js/index.html'  title='Navegar hacia la documentación Javascript'>    		
			    	<img border='0' style='vertical-align: middle' src='../../../../../api/media/javascript-small.png' /></a>
			  </tr>
			
			  <tr>
			    <td colspan='2' class='header-menu'>
			  		  [ <a href='http://desarrollos.siu.edu.ar/trac/toba/wiki/Referencia/Auditoria' title='El sitio online contiene contenidos mas detallados y actualizados'
						class='menu'>Ver online</a> ]
			    </td>
			
			  </tr>
			  <tr><td colspan='2' class='header-line'><img src='../../../../../api/media/empty.png' width='1' height='1' border='0' alt=''  /></td></tr>
			</table>
		


<div id="banner">

<div id="header"><a id="logo" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba"><img src="../../chrome/site/logo_toba_siu.gif" width="282" height="90" alt="Toba" /></a><hr /></div>

<form id="search" action="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/search" method="get">
 <div>
  <label for="proj-search">Search:</label>
  <input type="text" id="proj-search" name="q" size="10" accesskey="f" value="" />
  <input type="submit" value="Search" />
  <input type="hidden" name="wiki" value="on" />
  <input type="hidden" name="changeset" value="on" />
  <input type="hidden" name="ticket" value="on" />
 </div>
</form>



<div id="metanav" class="nav"><ul><li class="first"><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/login">Login</a></li><li><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/settings">Settings</a></li><li><a accesskey="6" href="../TracGuide.html">Help/Guide</a></li><li class="last"><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/about">About Trac</a></li></ul></div>
</div>

<div id="mainnav" class="nav"><ul><li class="active first"><a accesskey="1" href="../../wiki.html">Wiki</a></li><li><a accesskey="2" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/timeline">Timeline</a></li><li><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/browser">Browse Source</a></li><li class="last"><a accesskey="4" href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/search">Search</a></li></ul></div>
<div id="main">




<div id="ctxtnav" class="nav">
 <h2>Wiki Navigation</h2>
 <ul>
   <li><a href="../../wiki.html">Start Page</a></li>
   <li><a href="../TitleIndex.html">Index by Title</a></li>
   <li><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/wiki/RecentChanges">Index by Date</a></li>
   <li class="last"><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/wiki/Referencia/Auditoria?action=diff&amp;version=11">Last Change</a></li>
 </ul>
 <hr />
</div>

<div id="content" class="wiki">

 
  
  
   
   <div class="wikipage">
    <div id="searchable"><h1 id="AuditoríadeCambiosenTablas">Auditoría de Cambios en Tablas</h1>
<p>
Basado en el trabajo de Pablo Revel sobre SIU-Quilmes y <a class="ext-link" href="../../../../external.html?link=http://www.lugli.org.ar/mediawiki/index.php/PostgreSQLyAuditoria"><span class="icon">http://www.lugli.org.ar/mediawiki/index.php/PostgreSQLyAuditoria</span></a>
</p>
<p>
Existe una manera sencilla de ir manteniendo los cambios históricos de una tabla de forma transparente a la aplicación. Consiste en asociar triggers al alta/baja/modificación de registros de un tabla e ir almacenando los cambios en una tabla paralela en otro esquema de la misma base. A partir de la versión 1.2.0 de Toba hay una clase disponible para crear los triggers, procedimientos almacenados y esquema paralelo al principal.
</p>
<h2 id="Creación">Creación</h2>
<p>
El primer paso es crear el esquema de triggers y tablas replicadas. Esto se hace con el comando
</p>
<pre class="wiki">toba proyecto crear_auditoria -p toba_referencia
</pre><p>
Opcionalmente se puede incluir la creación de este esquema en la instalación misma de la aplicación, seleccionando un subconjunto de tablas a auditar. Ver <a class="wiki" href="Administracion.html">Extensión de la administración</a>.
</p>
<p>
Una vez ejecutado el comando ya contamos con el esquema de auditoría en la misma base de negocios
</p>
<p>
<a style="padding:0; border:none" href="../../attachment/wiki/Referencia/Auditoria/esquema_auditoria.html"><img src="../../attachment/wiki/Referencia/Auditoria/esquema_auditoria41f0.png?format=raw" /></a>
</p>
<h2 id="Actualización">Actualización</h2>
<p>
No está incluido en la versión 1.2, pero se puede armar un comando para actualizar los sp y triggers en caso de cambios de estructura:
</p>
<div class="code"><pre><span class="code-lang">&lt;?php</span>

<span class="code-keyword">class </span><span class="code-lang">IDPROYECTO_comando </span><span class="code-keyword">extends </span><span class="code-lang">toba_aplicacion_comando_base</span>
<span class="code-keyword">{
    
    </span><span class="code-comment">/**
     * Crea un esquema de auditoria sobre las tablas de negocio
     */
    </span><span class="code-keyword">function </span><span class="code-lang">opcion__actualizar_auditoria</span><span class="code-keyword">()
    {
        </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">modelo</span><span class="code-keyword">-&gt;</span><span class="code-lang">actualizar_auditoria</span><span class="code-keyword">();
    }    
        
    
}


class </span><span class="code-lang">IDPROYECTO_modelo </span><span class="code-keyword">extends </span><span class="code-lang">toba_aplicacion_modelo_base</span>
<span class="code-keyword">{
    
    function </span><span class="code-lang">actualizar_auditoria</span><span class="code-keyword">(</span><span class="code-lang">$tablas</span><span class="code-keyword">=array(), </span><span class="code-lang">$prefijo_tablas</span><span class="code-keyword">=</span><span class="code-lang">null</span><span class="code-keyword">, </span><span class="code-lang">$con_transaccion</span><span class="code-keyword">=</span><span class="code-lang">true</span><span class="code-keyword">)
    {
        </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">manejador_interface</span><span class="code-keyword">-&gt;</span><span class="code-lang">mensaje</span><span class="code-keyword">(</span><span class="code-string">'Regenerando triggers y sp de auditoria'</span><span class="code-keyword">, </span><span class="code-lang">false</span><span class="code-keyword">);
        </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">manejador_interface</span><span class="code-keyword">-&gt;</span><span class="code-lang">progreso_avanzar</span><span class="code-keyword">();
        </span><span class="code-lang">$fuentes </span><span class="code-keyword">= </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">proyecto</span><span class="code-keyword">-&gt;</span><span class="code-lang">get_indice_fuentes</span><span class="code-keyword">();
        if (empty(</span><span class="code-lang">$fuentes</span><span class="code-keyword">)) {
            return;
        }
        </span><span class="code-lang">$id_def_base </span><span class="code-keyword">= </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">proyecto</span><span class="code-keyword">-&gt;</span><span class="code-lang">construir_id_def_base</span><span class="code-keyword">(</span><span class="code-lang">current</span><span class="code-keyword">(</span><span class="code-lang">$fuentes</span><span class="code-keyword">));
        </span><span class="code-lang">$base </span><span class="code-keyword">= </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">instalacion</span><span class="code-keyword">-&gt;</span><span class="code-lang">conectar_base</span><span class="code-keyword">(</span><span class="code-lang">$id_def_base</span><span class="code-keyword">);        
        if (</span><span class="code-lang">$con_transaccion</span><span class="code-keyword">) {
            </span><span class="code-lang">$base</span><span class="code-keyword">-&gt;</span><span class="code-lang">abrir_transaccion</span><span class="code-keyword">();
        }
        </span><span class="code-comment">//--- Tablas de auditoría
        </span><span class="code-lang">$auditoria </span><span class="code-keyword">= new </span><span class="code-lang">toba_auditoria_tablas_postgres</span><span class="code-keyword">(</span><span class="code-lang">$base</span><span class="code-keyword">);
        if (empty(</span><span class="code-lang">$tablas</span><span class="code-keyword">)) {
            </span><span class="code-lang">$auditoria</span><span class="code-keyword">-&gt;</span><span class="code-lang">agregar_tablas</span><span class="code-keyword">(</span><span class="code-lang">$prefijo_tablas</span><span class="code-keyword">);
        } else {
            foreach(</span><span class="code-lang">$tablas </span><span class="code-keyword">as </span><span class="code-lang">$tabla</span><span class="code-keyword">) {
                </span><span class="code-lang">$auditoria</span><span class="code-keyword">-&gt;</span><span class="code-lang">agregar_tabla</span><span class="code-keyword">(</span><span class="code-lang">$tabla</span><span class="code-keyword">);
            }
        }
        </span><span class="code-lang">$auditoria</span><span class="code-keyword">-&gt;</span><span class="code-lang">regenerar</span><span class="code-keyword">();
        if (</span><span class="code-lang">$con_transaccion</span><span class="code-keyword">) {
            </span><span class="code-lang">$base</span><span class="code-keyword">-&gt;</span><span class="code-lang">cerrar_transaccion</span><span class="code-keyword">();
        }
        </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">manejador_interface</span><span class="code-keyword">-&gt;</span><span class="code-lang">progreso_fin</span><span class="code-keyword">();
    }    
    
}</span>

<span class="code-lang">?&gt;</span>

</pre></div><h2 id="Ejecución">Ejecución</h2>
<p>
Una vez creado el esquema a medida que se vayan modificando las tablas originales se van guardando las modificaciones en las tablas de auditoría. Para que el usuario almacenado en estas tablas refleje el usuario actual logueado al sistema (y no el usuario con el cual se conecta a la base que suele ser único por aplicación) es necesario guardar en una tabla temporal el usuario actual, una forma sencilla de asegurar esto es extender la fuente de datos y usar la ventana post_conectar:
</p>
<div class="code"><pre><span class="code-lang">&lt;?php</span>

<span class="code-keyword">class </span><span class="code-lang">toba_referencia_fuente_datos </span><span class="code-keyword">extends </span><span class="code-lang">toba_fuente_datos</span>
<span class="code-keyword">{
    </span><span class="code-comment">/**
    *    Una vez conectado a la base se crea una tabla temporal conteniendo el usuario actual 
    */
    </span><span class="code-keyword">function </span><span class="code-lang">post_conectar</span><span class="code-keyword">()
    {
        </span><span class="code-lang">$usuario </span><span class="code-keyword">= </span><span class="code-lang">toba</span><span class="code-keyword">::</span><span class="code-lang">usuario</span><span class="code-keyword">()-&gt;</span><span class="code-lang">get_id</span><span class="code-keyword">();
        if (isset(</span><span class="code-lang">$usuario</span><span class="code-keyword">)) {
            </span><span class="code-lang">$sql </span><span class="code-keyword">= </span><span class="code-string">'CREATE TEMP TABLE tt_usuario ( usuario VARCHAR(30) );'</span><span class="code-keyword">;
            </span><span class="code-lang">$sql </span><span class="code-keyword">.= </span><span class="code-string">"INSERT INTO tt_usuario (usuario) VALUES ('$usuario')"</span><span class="code-keyword">;             
               </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">db</span><span class="code-keyword">-&gt;</span><span class="code-lang">ejecutar</span><span class="code-keyword">(</span><span class="code-lang">$sql</span><span class="code-keyword">);
        }
    }
    
}</span>

<span class="code-lang">?&gt;</span>

</pre></div><h2 id="Consulta">Consulta</h2>
<p>
Existe una operación de consulta de sucesos básica en el proyecto <a class="wiki" href="../Proyectos/toba_usuarios.html">toba_usuarios</a>.
</p>
</div>
   </div>
   
    <h3 id="tkt-changes-hdr">Attachments</h3>
    <ul class="tkt-chg-list"><li class="tkt-chg-change"><a href="../../attachment/wiki/Referencia/Auditoria/esquema_auditoria.html">esquema_auditoria.png</a> (5.9 kB) - added by seba on 12/20/07 15:00:10.</li>
    </ul>
  
  
  <script type="text/javascript">
   addHeadingLinks(document.getElementById("searchable"), "Link to this section");
  </script>
 
 
</div>

<script type="text/javascript">searchHighlight()</script>
<div id="altlinks"><h3>Download in other formats:</h3><ul><li class="first last"><a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/wiki/Referencia/Auditoria?format=txt">Plain Text</a></li></ul></div>

</div>

<div id="footer">
 <hr />
 <a id="tracpowered" href="../../../../external.html?link=http://trac.edgewall.org/"><img src="../../chrome/common/trac_logo_mini.png" height="30" width="107"
   alt="Trac Powered"/></a>
 <p class="left">
  Powered by <a href="../../../../external.html?link=https://desarrollos.siu.edu.ar/trac/toba/about"><strong>Trac 0.10.3</strong></a><br />
  By <a href="../../../../external.html?link=http://www.edgewall.org/">Edgewall Software</a>.
 </p>
 <p class="right">
  Creado por el SIU<br /><a href="../../../../external.html?link=http://www.siu.edu.ar/">http://www.siu.edu.ar</a>
 </p>
</div>



 </body>
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>

