<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="../../../../../external.html?link=http://www.w3.org/1999/xhtml">
  
  

  


  

  <!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>
    <title>
      Referencia/FuenteDatos/Auditoria – SIU-Toba
    </title>
        <link rel="search" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/search" />
        <link rel="help" href="../../TracGuide.html" />
        <link rel="alternate" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?format=txt" type="text/x-trac-wiki" title="Plain Text" />
        <link rel="up" href="../FuenteDatos.html" title="View parent page" />
        <link rel="start" href="../../../wiki.html" />
        <link rel="stylesheet" href="../../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../../chrome/common/css/wiki.css" type="text/css" />
        <link rel="shortcut icon" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/favicon.ico" type="image/x-icon" />
        <link rel="icon" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/favicon.ico" type="image/x-icon" />
      <link type="application/opensearchdescription+xml" rel="search" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/search/opensearch" title="Search SIU-Toba" />
    <script type="text/javascript" src="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/chrome/common/js/jquery.js"></script><script type="text/javascript" src="../../../chrome/common/js/trac.js"></script><script type="text/javascript" src="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/chrome/common/js/search.js"></script>
    <!--[if lt IE 7]>
    <script type="text/javascript" src="/trac/toba/chrome/common/js/ie_pre7_hacks.js"></script>
    <![endif]-->
    <script type="text/javascript">
      jQuery(document).ready(function($) {
        $("#content").find("h1,h2,h3,h4,h5,h6").addAnchor("Link to this section");
      });
    </script>
    <script type="text/javascript" src="../../../chrome/site/mootools.js"></script>
    <script type="text/javascript" src="../../../chrome/site/slimbox.js"></script>
    <link rel="stylesheet" href="../../../chrome/site/portada.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="../../../chrome/site/slimbox.css" type="text/css" media="screen" />
    <a style="position: absolute; top: 5px; left:5px;border-bottom:none !important;" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba"><img src="../../../chrome/site/logo_toba_siu.gif" width="282" height="90" alt="Toba" /></a>
    <link rel="stylesheet" type="text/css" href="../../../chrome/site/style.css" />
  </head>
  
			<body>
			<table border='0' cellspacing='0' cellpadding='0' height='48' width='100%'>
			  <tr>
			
				<td class='header-top-left'><img src='../../../../../../api/media/logo.png' border='0'/></td>
			    <td class='header-top-right'>
			    		<img border='0' style='vertical-align: middle' src='../../../../../../api/media/wiki.png' />
			    	<a href='../../../../../../api/index.html'  title='Navegar hacia la documentación PHP'>
			    		<img border='0' style='vertical-align: middle' src='../../../../../../api/media/php-small.png' /></a> 
			    	<a href='../../../../../../api_js/index.html'  title='Navegar hacia la documentación Javascript'>    		
			    	<img border='0' style='vertical-align: middle' src='../../../../../../api/media/javascript-small.png' /></a>
			  </tr>
			
			  <tr>
			    <td colspan='2' class='header-menu'>
			  		  [ <a href='http://repositorio.siu.edu.ar/trac/toba/wiki/Referencia/FuenteDatos/Auditoria' title='El sitio online contiene contenidos mas detallados y actualizados'
						class='menu'>Ver online</a> ]
			    </td>
			
			  </tr>
			  <tr><td colspan='2' class='header-line'><img src='../../../../../../api/media/empty.png' width='1' height='1' border='0' alt=''  /></td></tr>
			</table>
		
<a style="position: absolute; top: 5px; left:5px;border-bottom:none !important;" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba"><img src="../../../chrome/site/logo_toba_siu_original.gif" width="282" height="90" alt="SIU-Toba" /></a>
    <div id="siteheader">
    </div>
    <div id="banner">
      <div id="header">
        <a id="logo" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba"><img src="../../../chrome/site/logo_toba_siu.gif" alt="Toba" height="90" width="282" /></a>
      </div>
      <form id="search" action="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/search" method="get">
        <div>
          <label for="proj-search">Search:</label>
          <input type="text" id="proj-search" name="q" size="18" value="" />
          <input type="submit" value="Search" />
        </div>
      </form>
      <div id="metanav" class="nav">
    <ul>
      <li class="first"><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/login">Login</a></li><li><a href="../../TracGuide.html">Help/Guide</a></li><li><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/about">About Trac</a></li><li class="last"><a href="../../../prefs.html">Preferences</a></li>
    </ul>
  </div>
    </div>
    <div id="mainnav" class="nav">
    <ul>
      <li class="first active"><a href="../../../wiki.html">Wiki</a></li><li><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/timeline">Timeline</a></li><li><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/roadmap">Roadmap</a></li><li><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/browser">Browse Source</a></li><li><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/query">View Tickets</a></li><li class="last"><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/search">Search</a></li>
    </ul>
  </div>
    <div id="main">
      <div id="ctxtnav" class="nav">
        <h2>Context Navigation</h2>
          <ul>
              <li class="first"><a href="../FuenteDatos.html">Up</a></li><li><a href="../../WikiStart.html">Start Page</a> / <a href="../../Referencia.html">Referencia</a> / <a href="../FuenteDatos.html">FuenteDatos</a> / Auditoria</li><li><a href="../../TitleIndex.html">Index</a></li><li><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?action=history">History</a></li><li class="last"><a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?action=diff&amp;version=2">Last Change</a></li>
          </ul>
        <hr />
      </div>
    <div id="content" class="wiki">
      <p class="path noprint">
        <a class="pathentry" title="View Referencia" href="../../Referencia.html">Referencia</a><span class="pathentry sep">/</span><a class="pathentry" title="View Referencia/FuenteDatos" href="../FuenteDatos.html">FuenteDatos</a><span class="pathentry sep">/</span><a class="pathentry" title="View Referencia/FuenteDatos/Auditoria" href="Auditoria.html">Auditoria</a>
        <br style="clear: both" />
      </p>
      <div class="wikipage searchable">
        
          <h1 id="AuditoríadeCambiosenTablas">Auditoría de Cambios en Tablas</h1>
<p>
Basado en el trabajo de Pablo Revel sobre SIU-Quilmes y <a class="ext-link" href="../../../../../external.html?link=http://www.lugli.org.ar/mediawiki/index.php/PostgreSQLyAuditoria"><span class="icon"> </span>http://www.lugli.org.ar/mediawiki/index.php/PostgreSQLyAuditoria</a>
</p>
<p>
Existe una manera sencilla de ir manteniendo los cambios históricos de una tabla de forma transparente a la aplicación. Consiste en asociar triggers al alta/baja/modificación de registros de un tabla e ir almacenando los cambios en una tabla paralela en otro esquema de la misma base. A partir de la versión 1.2.0 de Toba hay una clase disponible para crear los triggers, procedimientos almacenados y esquema paralelo al principal.
</p>
<h2 id="CreaciónyActualización">Creación y Actualización</h2>
<p>
El primer paso es crear el esquema de triggers y tablas replicadas. Esto se hace con el comando
</p>
<pre class="wiki">toba proyecto crear_auditoria -p toba_referencia
</pre><p>
Opcionalmente se puede incluir la creación de este esquema en la instalación misma de la aplicación, seleccionando un subconjunto de tablas a auditar. Ver <a class="wiki" href="../Administracion.html">Extensión de la administración</a>.
</p>
<p>
Una vez ejecutado el comando ya contamos con el esquema de auditoría en la misma base de negocios
</p>
<p>
<a style="padding:0; border:none" href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria.html"><img src="../../../raw-attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria.png" /></a>
</p>
<p>
Si se realizan cambios en el modelo del negocio, se debe ejecutar nuevamente el comando para tomar estos cambios.
</p>
<p>
A partir de la version <strong>1.4.0</strong> de Toba la creación del esquema puede realizarse desde dentro del Editor, en la pantalla perteneciente a la configuración de la <a class="wiki" href="../FuenteDatos.html">fuente de datos</a>.
Esto se realiza mediante el botón ubicado en la parte inferior derecha de la pantalla, el cual dispara la creación/actualización del esquema de auditoría.
</p>
<p>
<a style="padding:0; border:none" href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos.html"><img src="../../../raw-attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos.png" /></a>
</p>
<h2 id="Ejecución">Ejecución</h2>
<p>
Una vez creado el esquema a medida que se vayan modificando las tablas originales se van guardando las modificaciones en las tablas de auditoría. Para que el usuario almacenado en estas tablas refleje el usuario actual logueado al sistema (y no el usuario con el cual se conecta a la base que suele ser único por aplicación) es necesario guardar en una tabla temporal el usuario actual, una forma sencilla de asegurar esto es extender la fuente de datos y usar la ventana post_conectar:
</p>
<div class="code"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">toba_referencia_fuente_datos</span> <span class="k">extends</span> <span class="nx">toba_fuente_datos</span>
<span class="p">{</span>
    <span class="sd">/**
    *   Una vez conectado a la base se crea una tabla temporal conteniendo el usuario actual 
    */</span>
    <span class="k">function</span> <span class="nf">post_conectar</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$usuario</span> <span class="o">=</span> <span class="nx">toba</span><span class="o">::</span><span class="na">usuario</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get_id</span><span class="p">();</span>
        <span class="nv">$id_solicitud</span> <span class="o">=</span> <span class="nx">toba</span><span class="o">::</span><span class="na">instancia</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get_id_solicitud</span><span class="p">();</span>      
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$usuario</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$usuario</span> <span class="o">=</span> <span class="s1">'publico'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'CREATE TEMP TABLE tt_usuario ( usuario VARCHAR(30), id_solicitud INTEGER);'</span><span class="p">;</span>
        <span class="nv">$usuario</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">quote</span><span class="p">(</span><span class="nv">$usuario</span><span class="p">);</span>
        <span class="nv">$id_solicitud</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">quote</span><span class="p">(</span><span class="nv">$id_solicitud</span><span class="p">);</span>
        <span class="nv">$sql</span> <span class="o">.=</span> <span class="s2">"INSERT INTO tt_usuario (usuario, id_solicitud) VALUES (</span><span class="si">$usuario</span><span class="s2">, </span><span class="si">$id_solicitud</span><span class="s2">)"</span><span class="p">;</span>          
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">db</span><span class="o">-&gt;</span><span class="na">ejecutar</span><span class="p">(</span><span class="nv">$sql</span><span class="p">);</span>
    <span class="p">}</span>
    
<span class="p">}</span>

<span class="cp">?&gt;</span><span class="x">
</span></pre></div><p>
A partir de la version <strong>1.4.0</strong> de Toba se puede configurar esto de dos maneras distintas:
</p>
<ul><li>Utilizando el check <i>Auditoría</i> que se visualiza en la imagen anterior. Esto hará que Toba genere automáticamente la tabla temporal antes mencionada luego de realizar la conexión.
</li><li>Manualmente como en el esquema previo, pero utilizando la nueva API en toba_fuente_datos. El cual es más inocuo a futuro.
<div class="code"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">toba_referencia_fuente_datos</span> <span class="k">extends</span> <span class="nx">toba_fuente_datos</span>
<span class="p">{</span>
    <span class="sd">/**
    *   Antes de conectarse a la base de datos, le digo que la misma posee esquema de auditoría
        *       De esta forma se creará automáticamente la tabla temporal y se asignará el usuario.
    */</span>
    <span class="k">function</span> <span class="nf">pre_conectar</span><span class="p">()</span>
    <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">set_fuente_posee_auditoria</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x">
</span></pre></div></li></ul><h2 id="Consulta">Consulta</h2>
<p>
Existe una operación de consulta de sucesos básica en el proyecto <a class="wiki" href="../../Proyectos/toba_usuarios.html">toba_usuarios</a>.
</p>

        
        
      </div>
          <h3>Attachments</h3>
          <ul>
              <li>
      <a href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria.html" title="View attachment">esquema_auditoria.png</a>
      <a href="../../../raw-attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria.png" title="Download" class="trac-rawlink"><img src="../../../chrome/common/download.png" alt="Download" /></a>
      (<span title="6005 bytes">5.9 KB</span>) - added by <em>seba</em>
      <a class="timeline" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/timeline?from=2009-06-26T14%3A37%3A10-0300&amp;precision=second" title="2009-06-26T14:37:10-0300 in Timeline">17 months</a> ago.
              </li>
              <li>
      <a href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos.html" title="View attachment">fuente_datos.png</a>
      <a href="../../../raw-attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos.png" title="Download" class="trac-rawlink"><img src="../../../chrome/common/download.png" alt="Download" /></a>
      (<span title="19254 bytes">18.8 KB</span>) - added by <em>seba</em>
      <a class="timeline" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/timeline?from=2009-06-26T14%3A37%3A30-0300&amp;precision=second" title="2009-06-26T14:37:30-0300 in Timeline">17 months</a> ago.
              </li>
          </ul>
    </div>
    <script type="text/javascript">
        jQuery.loadStyleSheet("../../../pygments/trac.css", "text/css");
    </script>
    <div id="altlinks">
      <h3>Download in other formats:</h3>
      <ul>
        <li class="last first">
          <a rel="nofollow" href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?format=txt">Plain Text</a>
        </li>
      </ul>
    </div>
    </div>
    <div id="footer" lang="en" xml:lang="en"><hr />
      <a id="tracpowered" href="../../../../../external.html?link=http://trac.edgewall.org/"><img src="../../../chrome/common/trac_logo_mini.png" height="30" width="107" alt="Trac Powered" /></a>
      <p class="left">
        Powered by <a href="../../../../../external.html?link=https://repositorio.siu.edu.ar/trac/toba/about"><strong>Trac 0.11.7</strong></a><br />
        By <a href="../../../../../external.html?link=http://www.edgewall.org/">Edgewall Software</a>.
      </p>
      <p class="right">Creado por SIU<br /><a href="../../../../../external.html?link=http://www.siu.edu.ar/">http://www.siu.edu.ar</a></p>
    </div>
    <div id="sitefooter">
    </div>
<script type="text/javascript">
if (document.getElementById('link_php')) {
document.getElementById('link_php').onclick = function() {
    location.href = '../../../../../external.html?link=http://desarrollos.siu.edu.ar/toba_editor_trunk/doc/api/index.html';
    return false;
}
document.getElementById('link_js').onclick = function() {
    location.href = '../../../../../external.html?link=http://desarrollos.siu.edu.ar/toba_editor_trunk/doc/api_js/index.html';
    return false;
}
document.getElementById('link_wiki').onclick = function() {
    location.href = '../../Referencia.html';
    return false;
}
}
</script>
  </body>
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>