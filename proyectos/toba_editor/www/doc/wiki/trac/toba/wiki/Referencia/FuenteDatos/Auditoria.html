<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
<head>
 <title>Referencia/FuenteDatos/Auditoria - SIU-Toba - Trac</title><link rel="start" href="../../../wiki.html" /><link rel="search" href="../../../../../external.html?link=https://localhost/trac/toba/search" /><link rel="help" href="../../TracGuide.html" /><link rel="stylesheet" href="../../../chrome/common/css/trac.css" type="text/css" /><link rel="stylesheet" href="../../../chrome/common/css/wiki.css" type="text/css" /><link rel="icon" href="../../../../../external.html?link=https://localhost/favicon.ico" type="image/x-icon" /><link rel="shortcut icon" href="../../../../../external.html?link=https://localhost/favicon.ico" type="image/x-icon" /><link rel="alternate" href="../../../../../external.html?link=https://localhost/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?format=txt" title="Plain Text" type="text/x-trac-wiki" /><style type="text/css">
.wikipage h2 {border-bottom: 1px solid gray;}

/* trac php syntax highlighting */
.code-block {
    line-height: 1em;
    font-family: Courier, monotype;
    font-size: 12px;
    }
.h_question { color: #0000BB; } /* highlight.default */
.hphp_commentline { color: #FF8000; } /* highlight.comment */
.hphp_operator { color: #007700; } /* highlight.keyword */
.hphp_word { color: #007700; } /* highlight.keyword */
.hphp_default {}
.hphp_variable { color: #0000BB; } /* highlight.default */
.hphp_hstring { color: #DD0000; } /* highlight.string */
.hphp_simplestring { color: #DD0000; } /* highlight.string */
.h_tagunknown {}
.h_default {}

.code-keyword { color: #007700; font-weight: normal; }
.code-lang { color: #0000BB; font-weight: normal; }
.code-comment { color: #FF8000; font-weight: normal;}
.code-string { color: #DD0000; font-weight: normal;}

pre { padding:0; margin: 0}

.tablas-screenshots td:first-child { background-color: #D5CECD; width: 30%}
.tablas-screenshots table { width: 90%; border: 1px solid gray; }
.tablas-screenshots td { }
.tablas-screenshots table.wiki td { border: 1px solid gray; }

#tkt-changes-hdr {
    clear: both;
    padding-top: 30px;
}
.wiki-toc {
    clear: right;
    min-width: 160px;
    background-color:#F7F7F7;    
    border: 1px solid #D7D7D7;
}
.wiki-toc .active {
    background-color: #890C71;
    padding: 1px;
}
.wiki-toc .active a {
    color:white; 
}
.wiki-toc .active a:hover {
    background-color:  #890C71;
}
.indice-general {
/*    background-color: #FFFFDD;*/
}
.wikipage h1 {
    padding-top: 5px;
}
.wikipage h2 {
 padding: 2px;
}
h1 {
    font-size: 28px;
}
.wikipage h2 {
    background-color: #890C71;
    color: white;
    padding-left: 10px;
    margin-top: 30px;
    font-size: 100%;
    border: 1px solid gray;
}
.wikipage h3 {
    font-size:100%;
}
.wikipage {
padding-right:10px;
}
li {
    margin-bottom:6px;
}
li * {
    margin-bottom:3px;
}
/*a {
 color: #890C71;
}*/
@media print {
 .wiki-toc { display: none }
}
#tkt-changes-hdr, .tkt-chg-list { 
    font-size:80%;
    text-align:right;
}

/** Cambios globales **/
#ctxtnav {
 /*display:none;*/
}
#mainnav {
 border: none;
 background: white;
 margin: 0;
 padding-top: 10px;
 padding-bottom: 35px;
border-bottom:1px solid #CCCCCC;

}
#mainnav li {
 border: 1px solid lightGray;
}
#header {
 display:none;
}
body {
    margin: 0;
    padding: 0;
      background-color:#F3F3F3;	    
}
#content {
clear: both;

}
#banner {
    background-color: white;
    padding-right:10px;
    padding-top:10px;
}

#mainnav .active :link, #mainnav .active :visited {
background:#890B72;
border-right:1px solid #000000;
border-top:medium none;
color:#EEEEEE;
font-weight:bold;
}
#mainnav :link, #mainnav :visited {
 border: none;
 background: transparent;
}
:link, :visited {
/* color: #1020EB;*/
/* color: #0C1BBC; */
 color: #67065D ;

}
#main {
 padding-left: 10px;
}
#footer {
 background-color: white;
 border-bottom: 1px solid;
}
</style>
 <script type="text/javascript" src="../../../chrome/common/js/trac.js"></script>
</head>

			<body>
			<table border='0' cellspacing='0' cellpadding='0' height='48' width='100%'>
			  <tr>
			
				<td class='header-top-left'><img src='../../../../../../api/media/logo.png' border='0'/></td>
			    <td class='header-top-right'>
			    		<img border='0' style='vertical-align: middle' src='../../../../../../api/media/wiki.png' />
			    	<a href='../../../../../../api/index.html'  title='Navegar hacia la documentación PHP'>
			    		<img border='0' style='vertical-align: middle' src='../../../../../../api/media/php-small.png' /></a> 
			    	<a href='../../../../../../api_js/index.html'  title='Navegar hacia la documentación Javascript'>    		
			    	<img border='0' style='vertical-align: middle' src='../../../../../../api/media/javascript-small.png' /></a>
			  </tr>
			
			  <tr>
			    <td colspan='2' class='header-menu'>
			  		  [ <a href='http://desarrollos.siu.edu.ar/trac/toba/wiki/Referencia/FuenteDatos/Auditoria' title='El sitio online contiene contenidos mas detallados y actualizados'
						class='menu'>Ver online</a> ]
			    </td>
			
			  </tr>
			  <tr><td colspan='2' class='header-line'><img src='../../../../../../api/media/empty.png' width='1' height='1' border='0' alt=''  /></td></tr>
			</table>
		

<script type="text/javascript" src="../../../chrome/site/mootools.js"></script>
<script type="text/javascript" src="../../../chrome/site/slimbox.js"></script>
<link rel="stylesheet" href="../../../chrome/site/portada.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../chrome/site/slimbox.css" type="text/css" media="screen" />
<a style='position: absolute; top: 5px; left:5px;border-bottom:none !important;' href="../../../../../external.html?link=https://localhost/trac/toba"><img src="../../../chrome/site/logo_toba_siu.gif" width="282" height="90" alt="Toba" /></a>

<div id="banner">

<div id="header"><a id="logo" href="../../../../../external.html?link=https://localhost/trac/toba"><img src="../../../chrome/site/logo_toba_siu.gif" width="282" height="90" alt="Toba" /></a><hr /></div>

<form id="search" action="../../../../../external.html?link=https://localhost/trac/toba/search" method="get">
 <div>
  <label for="proj-search">Search:</label>
  <input type="text" id="proj-search" name="q" size="10" accesskey="f" value="" />
  <input type="submit" value="Search" />
  <input type="hidden" name="wiki" value="on" />
  <input type="hidden" name="changeset" value="on" />
  <input type="hidden" name="ticket" value="on" />
 </div>
</form>



<div id="metanav" class="nav"><ul><li class="first"><a href="../../../../../external.html?link=https://localhost/trac/toba/login">Login</a></li><li><a href="../../../../../external.html?link=https://localhost/trac/toba/settings">Settings</a></li><li><a accesskey="6" href="../../TracGuide.html">Help/Guide</a></li><li class="last"><a href="../../../../../external.html?link=https://localhost/trac/toba/about">About Trac</a></li></ul></div>
</div>

<div id="mainnav" class="nav"><ul><li class="active first"><a accesskey="1" href="../../../wiki.html">Wiki</a></li><li><a accesskey="2" href="../../../../../external.html?link=https://localhost/trac/toba/timeline">Timeline</a></li><li><a accesskey="3" href="../../../../../external.html?link=https://localhost/trac/toba/roadmap">Roadmap</a></li><li><a href="../../../../../external.html?link=https://localhost/trac/toba/browser">Browse Source</a></li><li><a href="../../../../../external.html?link=https://localhost/trac/toba/query">View Tickets</a></li><li><a accesskey="7" href="../../../../../external.html?link=https://localhost/trac/toba/newticket">New Ticket</a></li><li class="last"><a accesskey="4" href="../../../../../external.html?link=https://localhost/trac/toba/search">Search</a></li></ul></div>
<div id="main">




<div id="ctxtnav" class="nav">
 <h2>Wiki Navigation</h2>
 <ul>
   <li><a href="../../../wiki.html">Start Page</a></li>
   <li><a href="../../TitleIndex.html">Index by Title</a></li>
   <li><a href="../../../../../external.html?link=https://localhost/trac/toba/wiki/RecentChanges">Index by Date</a></li>
   <li class="last"><a href="../../../../../external.html?link=https://localhost/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?action=diff&amp;version=2">Last Change</a></li>
 </ul>
 <hr />
</div>

<div id="content" class="wiki">

 
  
  
   
   <div class="wikipage">
    <div id="searchable"><p>
<a href="../../WikiStart.html">Inicio</a> / <a href="../../Referencia.html">Referencia</a> / <a href="../FuenteDatos.html">FuenteDatos</a> / Auditoria
</p>
<h1 id="AuditoríadeCambiosenTablas">Auditoría de Cambios en Tablas</h1>
<p>
Basado en el trabajo de Pablo Revel sobre SIU-Quilmes y <a class="ext-link" href="../../../../../external.html?link=http://www.lugli.org.ar/mediawiki/index.php/PostgreSQLyAuditoria"><span class="icon">http://www.lugli.org.ar/mediawiki/index.php/PostgreSQLyAuditoria</span></a>
</p>
<p>
Existe una manera sencilla de ir manteniendo los cambios históricos de una tabla de forma transparente a la aplicación. Consiste en asociar triggers al alta/baja/modificación de registros de un tabla e ir almacenando los cambios en una tabla paralela en otro esquema de la misma base. A partir de la versión 1.2.0 de Toba hay una clase disponible para crear los triggers, procedimientos almacenados y esquema paralelo al principal.
</p>
<h2 id="CreaciónyActualización">Creación y Actualización</h2>
<p>
El primer paso es crear el esquema de triggers y tablas replicadas. Esto se hace con el comando
</p>
<pre class="wiki">toba proyecto crear_auditoria -p toba_referencia
</pre><p>
Opcionalmente se puede incluir la creación de este esquema en la instalación misma de la aplicación, seleccionando un subconjunto de tablas a auditar. Ver <a class="wiki" href="../Administracion.html">Extensión de la administración</a>.
</p>
<p>
Una vez ejecutado el comando ya contamos con el esquema de auditoría en la misma base de negocios
</p>
<p>
<a style="padding:0; border:none" href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria.html"><img src="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria41f0.png?format=raw" /></a>
</p>
<p>
Si se realizan cambios en el modelo del negocio, se debe ejecutar nuevamente el comando para tomar estos cambios.
</p>
<p>
A partir de la version <strong>1.4.0</strong> de Toba la creación del esquema puede realizarse desde dentro del Editor, en la pantalla perteneciente a la configuración de la <a class="wiki" href="../FuenteDatos.html">fuente de datos</a>.
Esto se realiza mediante el botón ubicado en la parte inferior derecha de la pantalla, el cual dispara la creación/actualización del esquema de auditoría.
</p>
<p>
<a style="padding:0; border:none" href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos.html"><img src="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos41f0.png?format=raw" /></a>
</p>
<h2 id="Ejecución">Ejecución</h2>
<p>
Una vez creado el esquema a medida que se vayan modificando las tablas originales se van guardando las modificaciones en las tablas de auditoría. Para que el usuario almacenado en estas tablas refleje el usuario actual logueado al sistema (y no el usuario con el cual se conecta a la base que suele ser único por aplicación) es necesario guardar en una tabla temporal el usuario actual, una forma sencilla de asegurar esto es extender la fuente de datos y usar la ventana post_conectar:
</p>
<div class="code"><pre><span class="code-lang">&lt;?php</span>

<span class="code-keyword">class </span><span class="code-lang">toba_referencia_fuente_datos </span><span class="code-keyword">extends </span><span class="code-lang">toba_fuente_datos</span>
<span class="code-keyword">{
    </span><span class="code-comment">/**
    *    Una vez conectado a la base se crea una tabla temporal conteniendo el usuario actual 
    */
    </span><span class="code-keyword">function </span><span class="code-lang">post_conectar</span><span class="code-keyword">()
    {
        </span><span class="code-lang">$usuario </span><span class="code-keyword">= </span><span class="code-lang">toba</span><span class="code-keyword">::</span><span class="code-lang">usuario</span><span class="code-keyword">()-&gt;</span><span class="code-lang">get_id</span><span class="code-keyword">();
        </span><span class="code-lang">$id_solicitud </span><span class="code-keyword">= </span><span class="code-lang">toba</span><span class="code-keyword">::</span><span class="code-lang">instancia</span><span class="code-keyword">()-&gt;</span><span class="code-lang">get_id_solicitud</span><span class="code-keyword">();        
        if (! isset(</span><span class="code-lang">$usuario</span><span class="code-keyword">)) {
            </span><span class="code-lang">$usuario </span><span class="code-keyword">= </span><span class="code-string">'publico'</span><span class="code-keyword">;
        }
        </span><span class="code-lang">$sql </span><span class="code-keyword">= </span><span class="code-string">'CREATE TEMP TABLE tt_usuario ( usuario VARCHAR(30), id_solicitud INTEGER);'</span><span class="code-keyword">;
        </span><span class="code-lang">$usuario </span><span class="code-keyword">= </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">db</span><span class="code-keyword">-&gt;</span><span class="code-lang">quote</span><span class="code-keyword">(</span><span class="code-lang">$usuario</span><span class="code-keyword">);
        </span><span class="code-lang">$id_solicitud </span><span class="code-keyword">= </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">db</span><span class="code-keyword">-&gt;</span><span class="code-lang">quote</span><span class="code-keyword">(</span><span class="code-lang">$id_solicitud</span><span class="code-keyword">);
        </span><span class="code-lang">$sql </span><span class="code-keyword">.= </span><span class="code-string">"INSERT INTO tt_usuario (usuario, id_solicitud) VALUES ($usuario, $id_solicitud)"</span><span class="code-keyword">;             
           </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">db</span><span class="code-keyword">-&gt;</span><span class="code-lang">ejecutar</span><span class="code-keyword">(</span><span class="code-lang">$sql</span><span class="code-keyword">);
    }
    
}</span>

<span class="code-lang">?&gt;</span>

</pre></div><p>
A partir de la version <strong>1.4.0</strong> de Toba se puede configurar esto de dos maneras distintas:
</p>
<ul><li>Utilizando el check <i>Auditoría</i> que se visualiza en la imagen anterior. Esto hará que Toba genere automáticamente la tabla temporal antes mencionada luego de realizar la conexión.
</li><li>Manualmente como en el esquema previo, pero utilizando la nueva API en toba_fuente_datos. El cual es más inocuo a futuro.
<div class="code"><pre><span class="code-lang">&lt;?php</span>
<span class="code-keyword">class </span><span class="code-lang">toba_referencia_fuente_datos </span><span class="code-keyword">extends </span><span class="code-lang">toba_fuente_datos</span>
<span class="code-keyword">{
    </span><span class="code-comment">/**
    *    Antes de conectarse a la base de datos, le digo que la misma posee esquema de auditoría
        *       De esta forma se creará automáticamente la tabla temporal y se asignará el usuario.
    */
    </span><span class="code-keyword">function </span><span class="code-lang">pre_conectar</span><span class="code-keyword">()
    {
            </span><span class="code-lang">$this</span><span class="code-keyword">-&gt;</span><span class="code-lang">set_fuente_posee_auditoria</span><span class="code-keyword">(</span><span class="code-lang">true</span><span class="code-keyword">);
    }
}</span>
<span class="code-lang">?&gt;</span>

</pre></div></li></ul><h2 id="Consulta">Consulta</h2>
<p>
Existe una operación de consulta de sucesos básica en el proyecto <a class="wiki" href="../../Proyectos/toba_usuarios.html">toba_usuarios</a>.
</p>
</div>
   </div>
   
    <h3 id="tkt-changes-hdr">Attachments</h3>
    <ul class="tkt-chg-list"><li class="tkt-chg-change"><a href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/esquema_auditoria.html">esquema_auditoria.png</a> (5.9 kB) - added by seba on 06/26/09 14:37:10.</li><li class="tkt-chg-change"><a href="../../../attachment/wiki/Referencia/FuenteDatos/Auditoria/fuente_datos.html">fuente_datos.png</a> (18.8 kB) - added by seba on 06/26/09 14:37:30.</li>
    </ul>
  
  
  <script type="text/javascript">
   addHeadingLinks(document.getElementById("searchable"), "Link to this section");
  </script>
 
 
</div>

<script type="text/javascript">searchHighlight()</script>
<div id="altlinks"><h3>Download in other formats:</h3><ul><li class="first last"><a href="../../../../../external.html?link=https://localhost/trac/toba/wiki/Referencia/FuenteDatos/Auditoria?format=txt">Plain Text</a></li></ul></div>

</div>

<div id="footer">
 <hr />
 <a id="tracpowered" href="../../../../../external.html?link=http://trac.edgewall.org/"><img src="../../../chrome/common/trac_logo_mini.png" height="30" width="107"
   alt="Trac Powered"/></a>
 <p class="left">
  Powered by <a href="../../../../../external.html?link=https://localhost/trac/toba/about"><strong>Trac 0.10.3</strong></a><br />
  By <a href="../../../../../external.html?link=http://www.edgewall.org/">Edgewall Software</a>.
 </p>
 <p class="right">
  Creado por SIU<br /><a href="../../../../../external.html?link=http://www.siu.edu.ar/">http://www.siu.edu.ar</a>
 </p>
</div>


<script type='text/javascript'>
if (document.getElementById('link_php')) {
document.getElementById('link_php').onclick = function() {
    location.href = '../../../../../external.html?link=https://localhost/toba_editor_trunk/doc/api/index.html';
    return false;
}
document.getElementById('link_js').onclick = function() {
    location.href = '../../../../../external.html?link=https://localhost/toba_editor_trunk/doc/api_js/index.html';
    return false;
}
document.getElementById('link_wiki').onclick = function() {
    location.href = '../../Referencia.html';
    return false;
}
}

</script>
 </body>
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->
</html>

